/**
 * WYSIWYG Post & See Editor v1.0
 *
 * @author augustine
 *
 * Date: 2014/03/11
 */
String.format = function() {
	if (0 == arguments.length)
		return null;
	for (var a = arguments[0], g = 1; g < arguments.length; g++)
		a = a.replace(RegExp("\\{" + (g - 1) + "\\}", "gm"), arguments[g]);
	return a
};
(function(a) {
	var g = function(g, s) {
		function r() {
			a("#PSEditor .ps_drag").draggable({
				revert : "invalid",
				helper : "clone",
				appendTo : ".ps_dialog"
			});
			a("#PSEditor .ps_widget_content_div").droppable({
				accept : ".ps_drag",
				drop : function(c, b) {
					var d = b.draggable.find("img").data("src");
					a(this).find("img").attr("src", d);
					a(this).parents(".ps_divSwitch").data("del", !1)
				}
			});
			a("#PSEditor .ps_icon_trash").click(function() {
				a(this).parent().find("img").attr("src", "");
				a(this).parents(".ps_divSwitch").data("del", !0)
			})
		}

		function f(c) {
			w(c);
			x(c);
			z(c);
			A(c);
			B(c);
			C(c);
			D(c);
			a("#PSEditor .ps_cnl").click(k);
			E();
			r()
		}

		function e(c, b, d) {
			var e = (a(window).height() - d) / 2 + a(window).scrollTop(), h = (a(window).width() - b) / 2 + a(window).scrollLeft();
			0 > e && ( e = a(window).scrollTop());
			c.css({
				width : b,
				"max-height" : d,
				top : e + "px",
				left : h + "px"
			});
			c.show();
			a("#PSEditor_mask").fadeTo(250, 0.4)
		}

		function k() {
			a("#PSEditor textarea").val("");
			a("body").css("overflow", "auto");
			a("#PSEditor .ps_dialog").hide();
			a("#PSEditor #PSEditor_mask").hide();
			a("#PSEditor .ps_divGallery").css("left", 0);
			a("#PSEditor .ps_divSwitch").data("del", !1);
			t = 0
		}

		function E() {
			a("#PSEditor .ps_content .ps_picL").click(function() {
				var c = a(this).parent(".ps_content").find(".ps_divGallery");
				c.find(".ps_gallery");
				0 != t && (t--, c.animate({
					left : "+=74"
				}, "200"))
			});
			a("#PSEditor .ps_content .ps_picR").click(function() {
				var c = a(this).parent(".ps_content").find(".ps_divGallery"), b = c.find(".ps_gallery").length - 6;
				0 >= b || t == b || (t++, c.animate({
					left : "-=74"
				}, "200"))
			})
		}

		function w(v) {
			var b = a("#PSEditor .textEditor"), d = "";
			b.find(".ps_divGallery").append(a(q.original).addClass("ps_gallery"));
			var f = {
				width : 428,
				height : 297,
				controls : "bold italic underline | bullets | color | insertlink unlink | pastetext"
			};
			a.extend(!0, f, u);
			var h = b.find("textarea").cleditor(f);
			a(h[0].$frame[0].contentWindow).focus(function(a) {
				h.getHtml() == d && h[0].clear()
			});
			b.find(".ps_ok").click(function() {
				h.getHtml() ? c.html(h.getHtml()) : c.html(d);
				k()
			});
			a(v).delegate('[data-type="Text"]', "click", function(n) {
				n.preventDefault();
				c = a(this);
				d = c.data("text");
				b.find(".ps_content").hide();
				h.updateHtml(c.html());
				e(b, 500, 497)
			});
			a(v).delegate('[data-type="TextImage"]', "click", function(n) {
				n.preventDefault();
				c = a(this);
				d = c.data("text");
				b.find(".ps_content").show();
				h.updateHtml(c.html());
				e(b, 500, 497)
			})
		}

		function x(v) {
			var b = a("#PSEditor .imgSelector");
			b.find(".ps_album").append(a(q.thumb).find("img").addClass("albumimg ps_size80"));
			b.find(".ps_album img").click(function() {
				b.find(".ps_album img.blueborder").removeClass("blueborder");
				a(this).addClass("blueborder")
			});
			b.find(".ps_ok").click(function() {
				var a = b.find(".ps_album img.blueborder").data("src");
				c.find("img:first").attr("src", a);
				k()
			});
			a(v).delegate('[data-type="Image"]', "click", function(d) {
				d.preventDefault();
				c = a(this);
				d = c.find("img:first").attr("src");
				b.find(".ps_album img.blueborder").removeClass("blueborder");
				b.find('.ps_album img[data-src="' + d + '"]').addClass("blueborder");
				e(b, 476, 441)
			})
		}

		function F(a) {
			if ( a = a.match(/^.*(youtu|youku).*(.com\/be.com\/|.be\/|v\/|e\/|u\/w+\/|embed\/|v=|id_)([^#&?]*).*/i)) { a: {
					var b = a[3];
					switch(a[1].toLowerCase()) {
						case "youtu":
							a = String.format('<iframe width="640" height="360" src="{0}{1}" frameborder="0" data-id="{1}" allowfullscreen="0"></iframe>', "http://www.youtube.com/embed/", b);
							break a;
						case "youku":
							b = b.replace(".html", "");
							a = String.format('<iframe width="640" height="360" src="{0}{1}" frameborder="0" data-id="{1}" allowfullscreen="0"></iframe>', "http://player.youku.com/embed/", b);
							break a
					}
					a = ""
				}
				return a
			}
			return ""
		}

		function z(f) {
			var b = a("#PSEditor .movieEditor");
			b.find(".ps_ok").click(function() {
				c.find("img").remove();
				c.find("iframe").remove();
				c.prepend(F(a.trim(b.find("textarea").val())));
				k()
			});
			b.find("textarea").click(function() {
				this.select()
			});
			a(f).delegate('[data-type="Movie"]', "click", function(d) {
				d.preventDefault();
				c = a(this);
				0 < c.find("iframe").length && b.find("textarea").val(c.find("iframe").attr("src"));
				e(b, 500, 497)
			})
		}

		function A(f) {
			var b = a("#PSEditor .switchEditor"), d = "";
			b.find(".ps_divGallery").append(a(q.thumb).addClass("ps_gallery ps_drag"));
			var l = {
				width : 315,
				height : 90,
				controls : "outerlink"
			}, h = {
				width : 315,
				height : 90,
				controls : "bold italic underline | bullets | color | insertlink unlink | pastetext"
			};
			a.extend(!0, l, u);
			$switchArea1 = b.find(".switchArea1").cleditor(l);
			$switchArea1[0].$frame.contents().find("body").keypress(function(a) {
				a.preventDefault()
			});
			$switchArea1[0].focus();
			a.extend(!0, h, u);
			var n = b.find(".switchArea2").cleditor(h);
			a(n[0].$frame[0].contentWindow).focus(function(a) {
				n.getHtml() == d && n[0].clear()
			});
			b.find(".ps_ok").click(function() {
				b.find(".ps_widget_content_div img").each(function(b, d) {
					c.find('[data-type="AdImage"] img').eq(b).attr("src", a(d).attr("src"))
				});
				c.find('[data-type="AdUrl"]').html($switchArea1.getHtml());
				c.find('[data-type="AdText"]').html(n.getHtml());
				k()
			});
			a(f).delegate('[data-type="AdArea"]', "click", function(h) {
				h.preventDefault();
				c = a(this);
				d = c.find('[data-type="AdText"]').data("text");
				c.find('[data-type="AdImage"] img').each(function(c, d) {
					b.find(".ps_widget_content_div img").eq(c).attr("src", a(d).attr("src"))
				});
				$switchArea1.updateHtml(c.find('[data-type="AdUrl"]').html());
				n.updateHtml(c.find('[data-type="AdText"]').html());
				e(b, 500, 479)
			})
		}

		function B(f) {
			var b = a("#PSEditor .bannerEditor");
			b.find(".ps_divGallery").append(a(q.thumb).addClass("ps_gallery ps_drag"));
			var d = {
				width : 315,
				height : 90,
				controls : "outerlink"
			};
			a.extend(!0, d, u);
			var l = [];
			b.find("textarea").each(function(b) {
				var c = a(this).cleditor(d);
				c.focus();
				c[0].$frame.contents().find("body").keypress(function(a) {
					a.preventDefault()
				});
				l[b] = c
			});
			b.find(".ps_ok").click(function() {
				b.find(".ps_divSwitch").each(function(b, d) {
					c.find('[data-type="BannerImage"]').eq(b).data("del", a(this).data("del"));
					c.find('[data-type="BannerImage"] img').eq(b).attr("src", a(d).find("img").attr("src"));
					c.find('[data-type="BannerUrl"]').eq(b).html(l[b].getHtml())
				});
				k()
			});
			a(f).delegate('[data-type="BannerArea"]', "click", function(d) {
				d.preventDefault();
				c = a(this);
				a.each(l, function(a, d) {
					b.find(".ps_divSwitch").eq(a).data("del", c.find('[data-type="BannerImage"]').eq(a).data("del"));
					b.find(".ps_widget_content_div img").eq(a).attr("src", c.find('[data-type="BannerImage"] img').eq(a).attr("src"));
					d.updateHtml(c.find('[data-type="BannerUrl"]').eq(a).html())
				});
				e(b, 500, 642)
			})
		}

		function C(f) {
			var b = a("#PSEditor .switchEditor");
			b.find(".ps_ok").click(function() {
				c.find('img[data-type="ImageSrc"]:first').attr("src", b.find(".ps_widget_content_div img:first").attr("src"));
				var a = $switchArea1.getHtml();
				-1 == a.indexOf("[OpenNewPage]") ? c.removeAttr("target") : ( a = a.replace("[OpenNewPage]", ""), c.attr("target", "_blank"));
				c.attr("href", a);
				b.find(".ps_icon_trash").show();
				b.find(".ps_divSwitch:last").show();
				k()
			});
			b.find(".ps_cnl").click(function() {
				b.find(".ps_icon_trash").show();
				b.find(".ps_divSwitch:last").show()
			});
			a(f).delegate('[data-type="ImageLink"]', "click", function(d) {
				d.preventDefault();
				c = a(this);
				b.find(".ps_icon_trash").hide();
				b.find(".ps_divSwitch:last").hide();
				b.find(".ps_widget_content_div img:first").attr("src", c.find('img[data-type="ImageSrc"]:first').attr("src"));
				$switchArea1.updateHtml(c.attr("href"));
				e(b, 500, 479)
			})
		}

		function D(f) {
			var b = a("#PSEditor .slidesEditor");
			b.find(".ps_divGallery").append(a(q.thumb).addClass("ps_gallery ps_drag"));
			var d = {
				width : 315,
				height : 90,
				controls : "outerlink"
			};
			a.extend(!0, d, u);
			var l = [];
			b.find("textarea").each(function(b) {
				var c = a(this).cleditor(d);
				c.focus();
				c[0].$frame.contents().find("body").keypress(function(a) {
					a.preventDefault()
				});
				l[b] = c
			});
			b.find(".ps_ok").click(function() {
				b.find(".ps_divSwitch").each(function(b, d) {
					c.find('[data-type="SlidesSet"]').eq(b).data("del", a(this).data("del"));
					c.find('[data-type="SlidesImage"]').eq(b).attr("src", a(d).find("img").attr("src"));
					var f = c.find('[data-type="SlidesUrl"]').eq(b), e = l[b].getHtml();
					-1 == e.indexOf("[OpenNewPage]") ? f.removeAttr("target") : ( e = e.replace("[OpenNewPage]", ""), f.attr("target", "_blank"));
					f.attr("href", e)
				});
				k()
			});
			a(f).delegate('[data-type="SlidesArea"]', "click", function(d) {
				d.preventDefault();
				c = a(this);
				a.each(l, function(a, d) {
					b.find(".ps_divSwitch").eq(a).data("del", c.find('[data-type="SlidesImage"]').eq(a).data("del"));
					b.find(".ps_widget_content_div img").eq(a).attr("src", c.find('[data-type="SlidesImage"]').eq(a).attr("src"));
					d.updateHtml(c.find('[data-type="SlidesUrl"]').eq(a).attr("href"))
				});
				e(b, 500, 642);
				b.find(".ps_popup").scrollTop(0)
			})
		}

		var c, t = 0, q = {}, u = {
			colors : "FFF FCC FC9 FF9 FFC 9F9 9FF CFF CCF FCF CCC F66 F96 FF6 FF3 6F9 3FF 6FF 99F F9F BBB F00 F90 FC6 FF0 3F3 6CC 3CF 66C C6C 999 C00 F60 FC3 FC0 3C0 0CC 36F 63F C3C 666 900 C60 C93 990 090 399 33F 60C 939 333 600 930 963 660 060 366 009 339 636 000 300 630 633 330 030 033 006 309 303",
			fonts : "Arial,Arial Black,Comic Sans MS,Courier New,Narrow,Garamond,Georgia,Impact,Sans Serif,Serif,Tahoma,Trebuchet MS,Verdana",
			sizes : "1,2,3,4,5,6,7",
			styles : [["Paragraph", "<p>"], ["Header 1", "<h1>"], ["Header 2", "<h2>"], ["Header 3", "<h3>"], ["Header 4", "<h4>"], ["Header 5", "<h5>"], ["Header 6", "<h6>"]],
			useCSS : !1,
			docType : "",
			docCSSFile : "",
			bodyStyle : "margin: 4px; font-family:\u5fae\u8edf\u6b63\u9ed1\u9ad4, Arial; cursor:text"
		}, G = a.extend({
			getImgUrl : ""
		}, s);
		(function(c, b) {
			if ("" == b)
				throw "The option [getImgUrl] is necessary.";
			if (0 == a("#PSEditor").length) {
				var d = "";
				0 < a('script[src$="jquery.pseditor.min.js"]:first').length ? d = a('script[src$="jquery.pseditor.min.js"]:first').attr("src").replace("jquery.pseditor.min.js", "pseditor.html") : 0 < a('script[src$="jquery.pseditor.js"]:first').length && ( d = a('script[src$="jquery.pseditor.js"]:first').attr("src").replace("jquery.pseditor.js", "pseditor.html"));
				a.when(a.get(d), a.get(b, null, null, "json")).then(function(b, d) {
					var e = b[0], m = d[0], k = 0, p = [], g;
					for (g in m)
					p[k++] = m[g];
					for ( m = 0; m < p[0].length; m++)
						p[0][m] = String.format('<div><img src="{0}" data-src="{1}" /></div>', p[0][m], p[1][m]), p[1][m] = String.format('<div><img src="{0}" /></div>', p[1][m]);
					q.thumb = p[0].join("");
					q.original = p[1].join("");
					a("body").append(e);
					f(c)
				})
			} else
				f(c)
		})(g, G.getImgUrl)
	};
	a.fn.PSEditor = function(y) {
		var s = this.each(function() {
			if (
			void 0 == a(this).data("PSEditor")) {
				var r = new g(this, y);
				a(this).data("PSEditor", r)
			}
		});
		return new w(s)
	};
	var w = function(g) {
		function s(f) {
			f = a(f);
			var e = new x;
			e.Name = f.attr("data-element");
			e.Type = f.attr("data-type");
			switch(f.attr("data-type")) {
				case "AdImage":
				case "BannerImage":
				case "Image":
					e.Value = f.find("img").attr("src");
					break;
				case "Movie":
					0 < f.find("iframe").length && (e.Value = f.find("iframe").attr("src"));
					break;
				case "ImageLink":
				case "SlidesUrl":
					e.Value = f.attr("href");
					break;
				case "ImageSrc":
				case "SlidesImage":
					e.Value = f.attr("src");
					break;
				default:
					e.Value = a.trim(f.html()).replace(/\x3c!--(.*?)--\x3e/gm, "")
			}
			return e
		}

		function r(f) {
			var e = [];
			a(f).find("[data-element]").each(function() {
				e.push(s(this))
			});
			return e
		}
		this.Get = function(a) {
			try {
				return r(g[a])
			} catch(e) {
				throw e;
			}
		};
		this.GetAll = function() {
			var f = [];
			try {
				return a.each(g, function(a, e) {
					f.push(r(e))
				}), f
			} catch(e) {
				throw e;
			}
		}
	}, x = function() {
		this.Value = this.Type = this.Name = ""
	}
})(jQuery);
